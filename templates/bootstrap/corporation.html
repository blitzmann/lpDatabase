<?php include ('header.html') ?>
<?php include ('navbar.html') ?>

    <div class='container'>
        <div class='col-lg-10 col-md-offset-1'>
            <h3 class='nav'><?= $this->corpName ?></h3>
            <ul class='nav nav-tabs nav-justified'>
              <li class='active'><a href='#store' data-toggle="tab">LP Store</a></li>
              <li><a href='#info' data-toggle="tab">Info</a></li>
              <li><a href='#stations' data-toggle="tab">Stations</a></li>
            </ul>
            <div class='tab-content'>
                <div class='tab-pane active' id='store'>
                    <label class='checkbox'>
                        <input type='checkbox' class='toggle' id='filterToggle' value='true' data-toggle='filtering' /> Filtering Options
                    </label>
                    <fieldset id='filtering'>
                        <label class='checkbox'><input type='checkbox' class='filter' value='1' data-type='req' /> Hide Offers with Required Items</label>
                        <label class='checkbox'><input type='checkbox' class='toggle' value='true' data-toggle='ranges' /> Set Ranges</label>
                        <fieldset id='ranges'>
                            <label class='checkbox'><input type='checkbox' class='filter' id='range-lp' data-type='range' /> LP: 
                                <input class='blank' type='text' id='range-lp-min' size='8' /> to  
                                <input class='blank' type='text' id='range-lp-max'  size='8' /></label>
                            <label class='checkbox'><input type='checkbox' class='filter' id='range-isk' data-type='range' /> ISK: 
                                <input class='blank' type='text' id='range-isk-min' size='8' /> to  
                                <input class='blank' type='text' id='range-isk-max'  size='8' /></label>
                            <label class='checkbox'><input type='checkbox' class='filter' id='range-volume' data-type='range' /> Volume: 
                                <input class='blank' type='text' id='range-volume-min' size='8' /> to  
                                <input class='blank' type='text' id='range-volume-max'  size='8' /></label>
                            <label class='checkbox'><input type='checkbox' class='filter' id='range-lp2isk' data-type='range' /> ISK/LP: 
                                <input class='blank' type='text' id='range-lp2isk-min' size='8' /> to  
                                <input class='blank' type='text' id='range-lp2isk-max'  size='8' /></label>
                        </fieldset>
                        <label class='checkbox'><input type='checkbox' class='toggle' id='groupToggle' value='true' data-toggle='groups' /> Filter By Group</label>
                        <fieldset id='groups'>
                        <?php foreach ($this->filterGroups AS $id => $name): ?>
                            <div class="col-md-3">
                                <label class='checkbox'><input type='checkbox' class='filter' value='<?= $id ?>' data-type='group' /> <?= $name ?></label>
                            </div>
                        <?php endforeach; ?>
                        </fieldset>
                    </fieldset>
                    <table class='table table-striped table-hover table-condensed' id='offerList'>
                        <tr><th colspan='2'>Offer</th><th>Items Req</th><th>LP Cost</th><th>ISK Cost</th><th>Volume</th><th>ISK/LP</th></tr>
                        <?php foreach ($this->lpStore->offers AS $id => $offer): ?>
                            <tr 
                                data-group='<?= $offer->marketRoot ?>' 
                                data-isk='<?= $offer->iskCost ?>'
                                data-lp='<?= $offer->lpCost ?>' 
                                data-lp2isk='<?= $offer->lp2isk ?>'
                                data-volume='<?= $offer->totVolume ?>'
                                data-req='<?= (empty($offer->reqDetails) && empty($offer->manDetails) ? '0' : '1')?>'
                            >
                                <td class='typeImg'>
                                    <div class='imgRound' style='background: url("http://image.eveonline.com/Type/<?= $offer->typeID ?>_32.png");'>
                                        <img width='32' height='32' src='http://image.eveonline.com/Type/<?= $offer->typeID ?>_32.png' alt='Corp Icon' />
                                    </div>
                                </td>
                                <td><a href='<?= BASE_PATH ?>offer/<?= $id ?>/'><?= $offer->getDisplayName() ?></a></td>
                                <td><?= count($offer->reqDetails) ?><?= ($offer->bpc) ? ' + '.count($offer->manDetails) : null ?></td>
                                <td><?= number_format($offer->lpCost) ?></td>
                                <td><?= number_format($offer->iskCost) ?></td>
                                <td><?= number_format($offer->totVolume) ?></td>
                                <td><?= number_format($offer->lp2isk) ?></td>
                            </tr>
                        <?php endforeach; ?>
                    </table>
                </div>
                <div class='tab-pane' id='info'>
                    <pre>Corp info here</pre>
                </div>
                <div class='tab-pane' id='stations'>
                    <table class='table table-striped table-hover table-condensed' id='stationList'>
                        <tr><th>Station</th><th>Region</th><th>Security</th></tr>
                        <?php foreach($this->lpStore->getStations() AS $station): ?>
                        <tr>
                            <td><?= $station['stationName'] ?></td>
                            <td><?= $station['regionName'] ?></td>
                            <td><?= number_format($station['security'],1) ?></td>
                        </tr>
                        <?php endforeach; ?>
                    </table>
                </div>
            </div>
        </div>
   </div><!-- /.container -->

<?php include ('scripts.html') ?>

<script>
    $(document).ready(function() { 

        var cfg = {
            isk: {min:0,max:0},
            lp:  {min:0,max:0},
            lp2isk:  {min:0,max:0},
            volume:  {min:0,max:0}
        };
        
        $("#offerList tr").filter(function () {
            for (type in cfg) {
                tmp = parseInt($(this).data(type))
                
                if (tmp < cfg[type].min) { cfg[type].min = tmp; }
                if (tmp > cfg[type].max) { cfg[type].max = tmp; }
            }
        });
        
        for (type in cfg) {
            $('#range-'+type+'-min').attr('placeholder',cfg[type].min);
            $('#range-'+type+'-max').attr('placeholder',cfg[type].max);
        }

        console.log(cfg);
        // !- Bind checkboxes to show filters
        $('input[type="checkbox"].toggle').bind("change", function(){
            if (typeof $(this).data('toggle') != 'undefined') {
                if ($(this).is(":checked")) {
                    $("#"+$(this).data('toggle')).show(); }
                else {
                    $("#"+$(this).data('toggle')).hide();
                }
            }
        }).trigger('change');
        
        $('input[type="checkbox"].filter').bind("change", function(){
            switch ($(this).data('type')) {
                case 'group':
                    var filtered = $('*[data-group="'+this.value+'"]');
                    console.log("Affected offers: "+filtered.length);
                    
                    if ($(this).is(":checked")) {
                        filtered.addClass('hide'); }
                    else {
                        filtered.removeClass('hide'); }
                case 'req':
                    var filtered = $('*[data-req="1"]');
                    if ($(this).is(":checked")) {
                        filtered.addClass('hide'); }
                    else {
                        filtered.removeClass('hide'); }
                case 'range':
                    max = $('#'+$(this).attr('id')+'-max').val();
                    min = $('#'+$(this).attr('id')+'-min').val();
                    
                    $("#offerList tr").filter(function () {
                        if ($(this).data(type) > max || $(this).data(type) < min) {
                            $(this).hide(); }
                        else {
                            $(this).show(); }
                    });
            }
        }).trigger('toggle');
    });
</script>

<?php include ('footer.html') ?>